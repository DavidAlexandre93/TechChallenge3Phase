name: CI/CD - TechChallenge3Phase

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-test:
    name: ğŸ§© Build, Test & Docker Validation
    runs-on: ubuntu-latest

  steps:
    - name: ğŸ”½ Checkout repositÃ³rio
      uses: actions/checkout@v4

    - name: ğŸ³ Setup Docker
      uses: docker/setup-buildx-action@v3

    # ---------- FRONTEND ----------
    - name: ğŸ“¦ Instalar dependÃªncias (Frontend)
      working-directory: ./frontend
      run: npm install

    - name: ğŸ§ª Rodar testes (Frontend)
      working-directory: ./frontend
      run: npm test --if-present

    - name: ğŸ—ï¸ Build (Frontend)
      working-directory: ./frontend
      run: npm run build

    # ---------- BACKEND ----------
    - name: ğŸ“¦ Instalar dependÃªncias (Backend)
      working-directory: ./backend-bff
      run: npm install

    - name: ğŸ§ª Rodar testes (Backend)
      working-directory: ./backend-bff
      run: npm test --if-present

    - name: âœ… Verificar build (Backend)
      working-directory: ./backend-bff
      run: npm run build --if-present

    # ---------- DOCKER ----------
    - name: ğŸ³ Docker Compose Build
      run: docker compose build

    - name: ğŸš€ Subir containers
      run: docker compose up -d

    - name: ğŸ©º Healthcheck Backend
      run: |
        echo "Aguardando backend..."
        sleep 15
        curl -f http://localhost:4000/health

    - name: ğŸ§¹ Derrubar containers
      if: always()
      run: docker compose down --volumes