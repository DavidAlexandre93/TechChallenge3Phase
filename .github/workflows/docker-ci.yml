name: ğŸ” Teste CI com Docker

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: # permite rodar manualmente pelo GitHub

jobs:
  docker-build-test:
    name: Build & Test Containers
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§© Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ³ Configurar Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ“¦ Build imagens
        env:
            VITE_API_URL: ${{ secrets.VITE_API_URL }}
        run: docker compose build

      - name: ğŸ³ Subir stack Docker
        env:
            PORT: ${{ secrets.PORT }}
            MONGO_URI: ${{ secrets.MONGO_URI }}
            JWT_SECRET: ${{ secrets.JWT_SECRET }}
        run: docker compose up -d

      - name: ğŸ©º Aguardar healthchecks
        run: |
          echo "Aguardando backend..."
          for i in {1..30}; do
            if curl -s http://localhost:4000/health; then
              echo "Backend OK"
              exit 0
            fi
            sleep 2
          done
          echo "Backend nÃ£o subiu"
          docker compose logs backend
          exit 1
          docker compose ps

      - name: âœ… Testar endpoints
        run: |
          curl -f http://localhost:4000/health
          curl -f http://localhost:5173/

      - name: ğŸ§¹ Derrubar containers
        if: always()
        run: docker compose down --volumes